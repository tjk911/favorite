Originally forked from Chris Oliver (excid3).